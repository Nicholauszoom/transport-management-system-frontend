<app-main-layout>
  <div id="product-view" class="flex justify-content-center">
    <p-card>
      <ng-template pTemplate="header">
        <div class="flex align-items-center gap-2">
          <h2 class="m-0"><i class="pi pi-tag text-primary" style="font-size: 2rem;"></i>  Loan Details</h2>
        </div>

    <!-- Enhanced Progress Bar Section -->
<div class="progress-container" *ngIf="loan">
  <div class="progress-bar">
    <!-- Step 1: FSP Received -->
    <div class="progress-step" 
         [ngClass]="{'completed': isStepCompleted('fsp_received'), 'active': isCurrentStep('fsp_received')}">
      <div class="step-circle">
        <i class="pi pi-file" *ngIf="!isStepCompleted('fsp_received')"></i>
        <i class="pi pi-check" *ngIf="isStepCompleted('fsp_received')"></i>
      </div>
      <span class="step-label">FSP Received</span>
    </div>
    
    <!-- Progress Line 1 -->
    <div class="progress-line" [ngClass]="{'completed': isStepCompleted('fsp_accepted') || isStepCompleted('fsp_rejected')}"></div>
    
    <!-- Step 2: FSP Decision (Approved/Rejected) -->
    <div class="progress-step" 
         [ngClass]="{'completed': isStepCompleted('fsp_accepted') || isStepCompleted('fsp_rejected'), 
                    'active': isCurrentStep('fsp_accepted') || isCurrentStep('fsp_rejected'),
                    'rejected': isCurrentStep('fsp_rejected') || (isStepCompleted('fsp_rejected') && !canProceedAfterRejection('fsp_rejected'))}">
      <div class="step-circle">
        <i class="pi pi-thumbs-up" *ngIf="!isStepCompleted('fsp_accepted') && !isStepCompleted('fsp_rejected')"></i>
        <i class="pi pi-check" *ngIf="isStepCompleted('fsp_accepted')"></i>
        <i class="pi pi-times" *ngIf="isStepCompleted('fsp_rejected')"></i>
      </div>
      <span class="step-label">FSP Decision</span>
      <!-- Branch indicator -->
      <div class="branch-indicator" *ngIf="isCurrentStep('fsp_accepted') || isCurrentStep('fsp_rejected') || isStepCompleted('fsp_accepted') || isStepCompleted('fsp_rejected')">
        <span class="branch-label" [ngClass]="{'success': isCurrentStep('fsp_accepted') || isStepCompleted('fsp_accepted'), 'danger': isCurrentStep('fsp_rejected') || isStepCompleted('fsp_rejected')}">
          {{ isCurrentStep('fsp_accepted') || isStepCompleted('fsp_accepted') ? 'Approved' : 'Rejected' }}
        </span>
      </div>
    </div>
    
    <!-- Progress Line 2 (only show if FSP was approved) -->
    <div class="progress-line" 
         [ngClass]="{'completed': (isStepCompleted('employee_rejected') || isStepCompleted('hro_approved') || isStepCompleted('hro_rejected')),
                    'blocked': isStepCompleted('fsp_rejected')}"
         *ngIf="!isStepCompleted('fsp_rejected') || canProceedAfterRejection('fsp_rejected')"></div>
    
    <!-- Step 3: Employee/HRO Decision (only show if FSP approved) -->
    <div class="progress-step" 
         [ngClass]="{'completed': isStepCompleted('employee_rejected') || isStepCompleted('hro_approved') || isStepCompleted('hro_rejected'), 
                    'active': isCurrentStep('employee_rejected') || isCurrentStep('hro_approved') || isCurrentStep('hro_rejected'),
                    'rejected': isCurrentStep('employee_rejected') || isCurrentStep('hro_rejected'),
                    'hidden': isStepCompleted('fsp_rejected') && !canProceedAfterRejection('fsp_rejected')}"
         *ngIf="!isStepCompleted('fsp_rejected') || canProceedAfterRejection('fsp_rejected')">
      <div class="step-circle">
        <i class="pi pi-user" *ngIf="!isStepCompleted('employee_rejected') && !isStepCompleted('hro_approved') && !isStepCompleted('hro_rejected')"></i>
        <i class="pi pi-check" *ngIf="isStepCompleted('hro_approved')"></i>
        <i class="pi pi-times" *ngIf="isStepCompleted('employee_rejected') || isStepCompleted('hro_rejected')"></i>
      </div>
      <span class="step-label">HRO Review</span>
      <!-- Branch indicator -->
      <div class="branch-indicator" *ngIf="isCurrentStep('employee_rejected') || isCurrentStep('hro_approved') || isCurrentStep('hro_rejected') || isStepCompleted('employee_rejected') || isStepCompleted('hro_approved') || isStepCompleted('hro_rejected')">
        <span class="branch-label" [ngClass]="{'success': isCurrentStep('hro_approved') || isStepCompleted('hro_approved'), 'danger': isCurrentStep('employee_rejected') || isCurrentStep('hro_rejected') || isStepCompleted('employee_rejected') || isStepCompleted('hro_rejected')}">
          {{ getHRODecisionLabel() }}
        </span>
      </div>
    </div>
    
    <!-- Progress Line 3 (only show if HRO approved) -->
    <div class="progress-line" 
         [ngClass]="{'completed': isStepCompleted('disbursement_approved') || isStepCompleted('disbursement_rejected'),
                    'blocked': isStepCompleted('employee_rejected') || isStepCompleted('hro_rejected') || isStepCompleted('fsp_rejected')}"
         *ngIf="!isStepCompleted('employee_rejected') && !isStepCompleted('hro_rejected') && !isStepCompleted('fsp_rejected')"></div>
    
    <!-- Step 4: Disbursement (only show if HRO approved) -->
    <div class="progress-step" 
         [ngClass]="{'completed': isStepCompleted('disbursement_approved') || isStepCompleted('disbursement_rejected'), 
                    'active': isCurrentStep('disbursement_approved') || isCurrentStep('disbursement_rejected'),
                    'rejected': isCurrentStep('disbursement_rejected') || isStepCompleted('disbursement_rejected'),
                    'hidden': isStepCompleted('employee_rejected') || isStepCompleted('hro_rejected') || isStepCompleted('fsp_rejected')}"
         *ngIf="!isStepCompleted('employee_rejected') && !isStepCompleted('hro_rejected') && !isStepCompleted('fsp_rejected')">
      <div class="step-circle">
        <i class="pi pi-money-bill" *ngIf="!isStepCompleted('disbursement_approved') && !isStepCompleted('disbursement_rejected')"></i>
        <i class="pi pi-check" *ngIf="isStepCompleted('disbursement_approved')"></i>
        <i class="pi pi-times" *ngIf="isStepCompleted('disbursement_rejected')"></i>
      </div>
      <span class="step-label">Disburse</span>
      <!-- Branch indicator -->
      <div class="branch-indicator" *ngIf="isCurrentStep('disbursement_approved') || isCurrentStep('disbursement_rejected') || isStepCompleted('disbursement_approved') || isStepCompleted('disbursement_rejected')">
        <span class="branch-label" [ngClass]="{'success': isCurrentStep('disbursement_approved') || isStepCompleted('disbursement_approved'), 'danger': isCurrentStep('disbursement_rejected') || isStepCompleted('disbursement_rejected')}">
          {{ isCurrentStep('disbursement_approved') || isStepCompleted('disbursement_approved') ? 'Approved' : 'Rejected' }}
        </span>
      </div>
    </div>
  </div>
  
  <!-- Current Status Badge -->
  <!-- <div class="current-status">
    <span class="status-badge" [ngClass]="getStatusClass(loan.requestType)">
      {{ getStatusLabel(loan.requestType) }}
    </span>
  </div> -->
  
  <!-- Flow Status Summary -->
  <div class="flow-summary">
    <div class="flow-path">
      <span class="path-label">Process Flow:</span>
      <span class="path-steps">{{ getFlowPath() }}</span>
    </div>
  </div>
</div>
      </ng-template>
      
      <ng-container *ngIf="loan; else loadingOrEmpty">
         <div class="button-group">
           <p-button 
            label="Back to List" 
            icon="pi pi-arrow-left" 
            severity="secondary" 
            size="small"
            (click)="goBack()"/>

          <!-- Action Buttons for FSP Received Loans -->
        <div *ngIf="loan.requestType === 'fsp_received'">
           <div class="button-group">
          <p-button 
            label="Fsp Approve" 
            icon="pi pi-check" 
            severity="success"
            size="small"
            [loading]="isProcessing"
            (click)="loanApproveAction(loan.id,'APPROVED')"/>

          <p-button 
            label="Fsp Reject" 
            icon="pi pi-times" 
            severity="danger"
            size="small"
            [loading]="isProcessing"
            (click)="loanApproveAction(loan.id,'REJECTED')"/>
            </div>
        </div>
        <!-- Action Buttons for FSP Disburse Loans -->
        <div *ngIf="loan.requestType === 'hro_approved'">
           <div class="button-group">
          <p-button 
            label="Disburse Approve" 
            icon="pi pi-check" 
            severity="success"
            size="small"
            [loading]="isProcessing"
            (click)="loanDisbursementAction(loan.id,'APPROVED')"/>

          <p-button 
            label="Disburse Reject" 
            icon="pi pi-times" 
            severity="danger"
            size="small"
            [loading]="isProcessing"
            (click)="loanDisbursementAction(loan.id,'REJECTED')"/>
            </div>
        </div>

         <!-- Action Buttons for Approved FSP Disburse Loans -->
        <div *ngIf="loan.requestType === 'disbursement_approved'||loan.requestType === 'disbursement_rejected'">
           <div class="button-group">
          <p-button 
            label="Liquidate" 
            icon="pi pi-ban" 
            severity="danger"
            size="small"
            [loading]="isProcessing"
            (click)="loanLiquidationAction(loan.id)"/>
            </div>
        </div>
       </div>
        <p-tabView>
          <!-- Employee Information -->
          <p-tabPanel header="Employee Information">
            <div class="p-fluid grid">
              <div class="col-12 md:col-4">
                <strong>Check Number:</strong>
                <p>{{ loan.checkNumber || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>First Name:</strong>
                <p>{{ loan.firstName || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Middle Name:</strong>
                <p>{{ loan.middleName || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Last Name:</strong>
                <p>{{ loan.lastName || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Sex:</strong>
                <p>{{ loan.sex || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>NIN:</strong>
                <p>{{ loan.NIN || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Marital Status:</strong>
                <p>{{ loan.maritalStatus || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Employment Date:</strong>
                <p>{{ loan.employmentDate  }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Confirmation Date:</strong>
                <p>{{ loan.confirmationDate  }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Designation Code:</strong>
                <p>{{ loan.designationCode || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Designation Name:</strong>
                <p>{{ loan.designationName || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Vote Code:</strong>
                <p>{{ loan.voteCode || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Vote Name:</strong>
                <p>{{ loan.voteName || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Terms of Employment:</strong>
                <p>{{ loan.termsOfEmployment || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Retirement Date:</strong>
                <p>{{ loan.retirementDate || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Physical Address:</strong>
                <p>{{ loan.physicalAddress || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Email Address:</strong>
                <p>{{ loan.emailAddress || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Mobile Number:</strong>
                <p>{{ loan.mobileNumber || 'N/A' }}</p>
              </div>
            </div>
          </p-tabPanel>

          <!-- Salary Information -->
          <p-tabPanel header="Salary Information">
            <div class="p-fluid grid">
              <div class="col-12 md:col-4">
                <strong>Basic Salary:</strong>
                <p>{{ loan.basicSalary }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Net Salary:</strong>
                <p>{{ loan.netSalary}}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>One Third Amount:</strong>
                <p>{{ loan.oneThirdAmount}}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Total Employee Deduction:</strong>
                <p>{{ loan.totalEmployeeDeduction }}</p>
              </div>
            </div>
          </p-tabPanel>

          <!-- Loan Request -->
          <p-tabPanel header="Loan Request">
            <div class="p-fluid grid">
              <div class="col-12 md:col-4">
                <strong>Application Number:</strong>
                <p>{{ loan.applicationNumber || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Loan Type:</strong>
                <p>{{ loan.loanType || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Product Code:</strong>
                <p>{{ loan.productCode || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Requested Amount:</strong>
                <p>{{ loan.requestedAmount }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Desired Deductible Amount:</strong>
                <p>{{ loan.desiredDeductibleAmount}}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Tenure:</strong>
                <p>{{ loan.tenure }} months</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Interest Rate:</strong>
                <p>{{ loan.interestRate }}%</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Processing Fee:</strong>
                <p>{{ loan.processingFee }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Insurance:</strong>
                <p>{{ loan.insurance }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Loan Purpose:</strong>
                <p>{{ loan.loanPurpose || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Contract Start Date:</strong>
                <p>{{ loan.contractStartDate }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Contract End Date:</strong>
                <p>{{ loan.contractEndDate }}</p>
              </div>
            </div>
          </p-tabPanel>

          <!-- Loan Offer -->
          <p-tabPanel header="Loan Offer">
            <div class="p-fluid grid">
              <div class="col-12 md:col-4">
                <strong>Net Loan Amount:</strong>
                <p>{{ loan.netLoanAmount | currency:'Tsh ' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Take Home Amount:</strong>
                <p>{{ loan.takeHomeAmount | currency:'Tsh ' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Total Amount To Pay:</strong>
                <p>{{ loan.totalAmountToPay | currency:'Tsh ' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Interest Amount:</strong>
                <p>{{ loan.totalInterestRateAmount | currency:'Tsh ' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Insurance Amount:</strong>
                <p>{{ loan.insuranceProcessFee | currency:'Tsh ' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Processing Fees:</strong>
                <p>{{ 0 | currency:'Tsh ' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Other Charges Amount:</strong>
                <p>{{ loan.otherCharges | currency:'Tsh ' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Deductable Amount(/Monthly):</strong>
                <p>{{ loan.monthlyReturnAmount | currency:'Tsh ' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Tenure:</strong>
                <p>{{ loan.responseTenure }}</p>
              </div>
            </div>
          </p-tabPanel>

           <!-- Employee Response -->
          <p-tabPanel header="Employee Response" *ngIf="loan.requestType === 'employee_rejected'">
            <div class="p-fluid grid">
              <div class="col-12 md:col-4">
                <strong>Action:</strong>
                <p>REJECTED</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Reason:</strong>
                <p>{{ loan.essApprovalReason}}</p>
              </div>
            </div>
          </p-tabPanel>

          <!-- HRO Response -->
          <p-tabPanel header="HRO Response" *ngIf="loan.requestType === 'hro_approved'">
            <div class="p-fluid grid">
              <div class="col-12 md:col-4">
                <strong>Action:</strong>
                <p>{{ loan.requestType}}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Reason:</strong>
                <p>{{ loan.essApprovalReason}}</p>
              </div>
            </div>
          </p-tabPanel>

            <!-- Disbursement -->
            <p-tabPanel header="Disbursement" 
            *ngIf="loan.requestType === 'disbursement_approved' || loan.requestType === 'disbursement_rejected'">            <div class="p-fluid grid">
              <div class="col-12 md:col-4">
                <strong>Action:</strong>
                <p>{{ loan.requestType}}</p>
              </div>
              <div class="col-12 md:col-4">
                <strong>Disbursement Review Date:</strong>
                <p>{{ loan.disbursementDate}}</p>
              </div>
            </div>
          </p-tabPanel>

          <!-- Metadata -->
          <p-tabPanel header="Metadata">
            <div class="p-fluid grid">
              <div class="col-12 md:col-6">
                <strong>Record ID:</strong>
                <p>{{ loan.id }}</p>
              </div>
              <div class="col-12 md:col-6">
                <strong>Created Date:</strong>
                <p>{{ loan.createdDate }}</p>
              </div>
               <div class="col-12 md:col-6" *ngIf="loan.initialApproveDate != null">
                <strong>Fsp Initial Review Date:</strong>
                <p>{{ loan.initialApproveDate || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-6" *ngIf="loan.hroApproveDate != null">
                <strong>HRO Review Date:</strong>
                <p>{{ loan.hroApproveDate || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-6" *ngIf="loan.liquidationDate != null">
                <strong>Liquidation Date:</strong>
                <p>{{ loan.liquidationDate || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-6"  *ngIf="loan.employeeCancellDate != null">
                <strong>Employee Cancell:</strong>
                <p>{{ loan.employeeCancellDate || 'N/A' }}</p>
              </div>
              <div class="col-12 md:col-4" *ngIf="loan.disbursementDate != null">
                <strong>Disbursement Review Date:</strong>
                <p>{{ loan.disbursementDate}}</p>
              </div>
            </div>
          </p-tabPanel>

        </p-tabView>
      </ng-container>

      <ng-template #loadingOrEmpty>
        <div class="text-center">
          <p *ngIf="inProgress" class="text-primary">
            <i class="pi pi-spin pi-spinner"></i> Loading loan details...
          </p>
          <p *ngIf="!inProgress" class="text-secondary">No loan data available.</p>
        </div>
      </ng-template>
    </p-card>
  </div>
</app-main-layout>